pipeline{
    agent {
        label 'windows' 
    }

    tools{
        nodejs 'NodeJS'
        maven 'mvn'
    }

    stages{
        stage('Install appium'){
    steps{
        bat 'npm install -g appium'
        bat 'appium driver list --installed' | findstr /i "uiautomator2"

        // Check the output of the previous command (success/failure)
        if (test returnStatus == 0) {
            echo 'UiAutomator2 driver already installed.'
        } else {
            // Driver not found, install it
            bat 'appium driver install uiautomator2'
        }
    }
}


        //stage('Download images'){
          //  steps{
               // bat 'sdkmanager ${image}'
            //}
        //}

        stage('Create & Start emulator'){
            steps{
                bat 'avdmanager -s create avd -c 100M -k %image% -n pixel_8_pro --force'
                bat 'emulator -avd pixel_8_pro -no-window -no-boot-anim'
            }
        }

        stage('Start appium'){
            steps{
                bat 'appium'
            }
        }

        stage('Run the tests'){
            steps{
                bat 'mvn test'
            }
        }

    }
}
