pipeline {
  agent {
    label 'windows'
  }

  tools {
    nodejs 'NodeJS'
    maven 'mvn'
  }

  stages {
    stage('Install Appium') {
      steps {
        bat 'npm install -g appium'
      }
    }

    stage('Download Images') {
      steps {
        bat 'sdkmanager %image%'
      }
    }

    stage('Emulator & Appium (Parallel)') {
      parallel {
        stage('Create Emulator') {
            steps{
              bat 'avdmanager -s create avd -c 100M -k %image% -n pixel_8_pro --force'
              bat 'emulator -avd pixel_8_pro -no-window -gpu off'
            }
        }

        stage('Start Appium') {
          steps {
            bat 'appium'
          }
        }

        stage('Run Tests') {
          steps {
            bat 'timeout /t 300 /nobreak'
            bat 'mvn test'
          }
        }
      }

    }

  }

}
